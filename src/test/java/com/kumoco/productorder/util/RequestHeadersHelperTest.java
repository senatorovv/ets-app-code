package com.kumoco.productorder.util;

import org.json.JSONException;
import org.junit.jupiter.api.Test;

import static com.kumoco.productorder.util.RequestHeadersHelper.parseJwtToken;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

class RequestHeadersHelperTest {

    private static final String ERP_TOKEN = "eeyJraWQiOiI5NTc5NmFmZDU2MTA0Y2M4YjIxZDA2MjFjMzRmYzhkYyIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiJBUElHV19URVNUIiwiYXVkIjpbIkVSUCIsIkFQSUdXX1RFU1QiLCI8VkZPPiJdLCJhenAiOiJBUElHV19URVNUIiwiYXV0aF90aW1lIjoxNjIxNzU4MDYwLCJzY29wZSI6WyJJTlRFTlRfc2FsZXNPcmRlck5vdGlmeVJXIiwiVE1GNjIyOlJXIiwiS0NfRVJQX1JXIl0sImlzcyI6Imh0dHBzOlwvXC92Zm8temRzLXNndy1pc2d3LXNzbC16ZW50aXR5LXNndy5hcHBzLnJob2NwLm5vbi1wcm9kLWNsb3VkMS5pdGNsb3VkLmxvY2FsLnZvZGFmb25lLm9tIiwiZXh0ZXJuYWxBdXRob3JpemF0aW9uIjoiQmVhcmVyIGV5SjBlWEFpT2lKS1YxUWlMQ0poYkdjaU9pSlNVekkxTmlJc0luZzFkQ0k2SW01UGJ6TmFSSEpQUkZoRlN6RnFTMWRvV0hOc1NGSmZTMWhGWnlJc0ltdHBaQ0k2SW01UGJ6TmFSSEpQUkZoRlN6RnFTMWRvV0hOc1NGSmZTMWhGWnlKOS5leUpoZFdRaU9pSm9kSFJ3Y3pvdkwzTnBkREF3TVdFMlpUUm1ZVEl3TmpZM01USmpPVFZrWlhaaGIzTXVZMnh2ZFdSaGVDNWtlVzVoYldsamN5NWpiMjBpTENKcGMzTWlPaUpvZEhSd2N6b3ZMM04wY3k1M2FXNWtiM2R6TG01bGRDOWpNVGxqWlRNeE1pMHhabUl6TFRRM1pqSXRPV1JpTVMwNU1HSTBNRFF4WlRZMU5tVXZJaXdpYVdGMElqb3hOakl4TnpVM056WXhMQ0p1WW1ZaU9qRTJNakUzTlRjM05qRXNJbVY0Y0NJNk1UWXlNVGMyTVRZMk1Td2lZV2x2SWpvaVJUSmFaMWxMWjBsaE5XbDVZMll6WVVvMVVIVlFPRFYxY2xoWU5FUjNRVDBpTENKaGNIQnBaQ0k2SWprMFlqTmhPVFUwTFRreU0ySXRORGd6TmkwNU5EVXhMVGsxTUdZd016RXpaamRsWkNJc0ltRndjR2xrWVdOeUlqb2lNU0lzSW1sa2NDSTZJbWgwZEhCek9pOHZjM1J6TG5kcGJtUnZkM011Ym1WMEwyTXhPV05sTXpFeUxURm1Zak10TkRkbU1pMDVaR0l4TFRrd1lqUXdOREZsTmpVMlpTOGlMQ0p2YVdRaU9pSXpOMk5qWkdVeFlpMWlaRFV5TFRRek1ERXRZV014TUMxa1lUaGpabUU1TWpNek1HRWlMQ0p5YUNJNklqQXVRVk5GUVVWMVQyTjNZazFtT0d0bFpITmFRekJDUWpWc1lteFRjSE0xVVRkcmFscEpiRVpIVmtSM1RWUTVMVEJvUVVGQkxpSXNJbk4xWWlJNklqTTNZMk5rWlRGaUxXSmtOVEl0TkRNd01TMWhZekV3TFdSaE9HTm1ZVGt5TXpNd1lTSXNJblJwWkNJNkltTXhPV05sTXpFeUxURm1Zak10TkRkbU1pMDVaR0l4TFRrd1lqUXdOREZsTmpVMlpTSXNJblYwYVNJNkluUkVhMWt6YUZBd2VFVXlZMFpUVTJ4TGR6Tm1RVUVpTENKMlpYSWlPaUl4TGpBaWZRLmpJWVloVHY5S29QSk81czVUWTZzd1VGWEdUdnVLYWlLRDlzZ2ZwM0NrRTZEdUNXZmZmS091SktORjNJQjlaMnR4Qk5jWEtueGh3VXJtUUpXTTVUQ0I3V29jMjdRR05aeV9TYVRkellTVVNpZU1rNkNVZmExX3ZOV1dKUXZDbXAtWEtTQVZ5T2lPbFlnOWZaSUtubnFJYTBsUEhad0h1NnktUUlScC1CallJS2R5cmp4QkFSZjJBR2xyRHJhX2lEMWl4d1pFUmdmd2pQaEF3elRBaGhOWl9MOTEzT2RxYUx6UlhQUXVEc3lHTHRrQWdsbk94TWtXTE1vUG1XbVpENlY1c0ZGV2JCcnluMzdOQmZKTmh5b2szNk5hWEtuWlI1V1BfalBnTTZzQnNpZmZkZlkxamVINDFIbEFKT183YXZuTUlOSWJWZElVTS1fTk05S2oyUHp5QSIsImV4cCI6MTYyMTc2MTYzMCwiaWF0IjoxNjIxNzU4MDYwfQ.Qgaj13M0X_EXanheaqQOa-gVHLWgnXz0WhOOHady3a7EW08Onl7XxiPclEeJa93gB8YbF94AIc831VZw-upPacLzIPeS0OO2v7bNAG0dvWszAzA7AQMRTy-QGbju8c9cwjFyQfqhdxoeIq-zmGgzrhGGHhaIEN-k3E9-3IjuY-YPE_3hSErpIhIY1cJBtSTix03JJWBx8k7OHuddYCDXItuFgpflTlcqbyJL719IpriLmxrgc8oC6N0iI4XTctrhhgyiWQ2hyscTQXk11rJZm3xX_4n0nzuhQQwxYOngKLyrqosLchdZ_jdm0z6h8e4T1ezCPCuO2CQpoE12dGmz1A";

    private static final String EXTRACTED_TOKEN = "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL3NpdDAwMWE2ZTRmYTIwNjY3MTJjOTVkZXZhb3MuY2xvdWRheC5keW5hbWljcy5jb20iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9jMTljZTMxMi0xZmIzLTQ3ZjItOWRiMS05MGI0MDQxZTY1NmUvIiwiaWF0IjoxNjIxNzU3NzYxLCJuYmYiOjE2MjE3NTc3NjEsImV4cCI6MTYyMTc2MTY2MSwiYWlvIjoiRTJaZ1lLZ0lhNWl5Y2YzYUo1UHVQODV1clhYNER3QT0iLCJhcHBpZCI6Ijk0YjNhOTU0LTkyM2ItNDgzNi05NDUxLTk1MGYwMzEzZjdlZCIsImFwcGlkYWNyIjoiMSIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0L2MxOWNlMzEyLTFmYjMtNDdmMi05ZGIxLTkwYjQwNDFlNjU2ZS8iLCJvaWQiOiIzN2NjZGUxYi1iZDUyLTQzMDEtYWMxMC1kYThjZmE5MjMzMGEiLCJyaCI6IjAuQVNFQUV1T2N3Yk1mOGtlZHNaQzBCQjVsYmxTcHM1UTdralpJbEZHVkR3TVQ5LTBoQUFBLiIsInN1YiI6IjM3Y2NkZTFiLWJkNTItNDMwMS1hYzEwLWRhOGNmYTkyMzMwYSIsInRpZCI6ImMxOWNlMzEyLTFmYjMtNDdmMi05ZGIxLTkwYjQwNDFlNjU2ZSIsInV0aSI6InREa1kzaFAweEUyY0ZTU2xLdzNmQUEiLCJ2ZXIiOiIxLjAifQ.jIYYhTv9KoPJO5s5TY6swUFXGTvuKaiKD9sgfp3CkE6DuCWfffKOuJKNF3IB9Z2txBNcXKnxhwUrmQJWM5TCB7Woc27QGNZy_SaTdzYSUSieMk6CUfa1_vNWWJQvCmp-XKSAVyOiOlYg9fZIKnnqIa0lPHZwHu6y-QIRp-BjYIKdyrjxBARf2AGlrDra_iD1ixwZERgfwjPhAwzTAhhNZ_L913OdqaLzRXPQuDsyGLtkAglnOxMkWLMoPmWmZD6V5sFFWbBryn37NBfJNhyok36NaXKnZR5WP_jPgM6sBsiffdfY1jeH41HlAJO_7avnMINIbVdIUM-_NM9Kj2PzyA";

    private static final String MISSING_EMBEDDED_TOKEN = "Bearer eyJraWQiOiJiM2I0N2M4ZWEyMGM0MTE3YmRiNTBkNzBhMzliNjM3MiIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiJBUElHV19URVNUIiwiYXVkIjpbIkFQSUdXX1RFU1QiLCI8VkZPPiJdLCJhenAiOiJBUElHV19URVNUIiwiYXV0aF90aW1lIjoxNjIxOTM5MjA2LCJzY29wZSI6W10sImlzcyI6Imh0dHBzOlwvXC92Zm8temRzLXNndy1pc2d3LXNzbC16ZW50aXR5LXNndy5hcHBzLnJob2NwLm5vbi1wcm9kLWNsb3VkMS5pdGNsb3VkLmxvY2FsLnZvZGFmb25lLm9tIiwiZXhwIjoxNjIxOTQwMTA2LCJpYXQiOjE2MjE5MzkyMDZ9.aKgSrTDq12N-iJPiGqtyDHaulP-jctwWQxN9Hl8zBSltqPVC5rHuUFhFtl8bqzYc6nj6pjQi6uiDGrumjtv5a3fHsEYeEPDnO8WYFqCj9eVBGVnq8dSVWD8911tK7Im1BbywW6b_KyzB1BdJRqVoZ-cqSum2EB-VyxCe5aL65Azr4O3X0_JCFgk0g2eCzHAc0RmYmMFHJce3AJ4mHy_MQjf1MnHUabI-YHP3Yz2MeMppmXyAfbs1N3BcBleMOyYB1BSoe6I3ZRNG6veay_XM7uBd4YaMvhpF6_T9_lWQre3xKPweDjxSa28Ie_BvJsHgodrWmxn7hKwR64P4Tm6ciQ";

    @Test
    void shouldIgnoreNullToken() {

        assertThat(parseJwtToken(null)).isNull();
    }

    @Test
    void shouldIgnoreOtherPassedTokens() {

        assertThat(parseJwtToken("Bearer blah")).isEqualTo("Bearer blah");
    }

    @Test
    void shouldParseErpAuthHeader() {

        assertThat(parseJwtToken("Bearer " + ERP_TOKEN)).isEqualTo(EXTRACTED_TOKEN);
    }

    @Test
    void shouldParseErpAuthHeaderWithWhitespace() {

        assertThat(parseJwtToken("Bearer                " + ERP_TOKEN)).isEqualTo(EXTRACTED_TOKEN);
    }

    @Test
    void shouldThrowErrorWhenParsingErpAuthHeaderWithInvalidJwtHeader() {

        assertThatThrownBy(() -> parseJwtToken("Bearer " + "eeyJraWQiOiI5NTc5NmFmZDU2MTA0Y2M4YjIxZDA2MjFjMzRmYzhkYyIsImFsZyI6IlJTMjU2In0.blah.asdasdadas"))
                .isInstanceOf(JSONException.class);
    }

    @Test
    void shouldReturnOriginalTokenIfParsingErpAuthHeadeWithMissingEmbeddedToken() {

        assertThat(parseJwtToken(MISSING_EMBEDDED_TOKEN)).isEqualTo(MISSING_EMBEDDED_TOKEN);
    }
}
